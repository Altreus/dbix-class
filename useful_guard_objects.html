<html><head><title>What</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" type="text/css" title="pod_stylesheet" href="http://search.cpan.org/s/style.css">

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.03,
  using Pod::Simple::PullParser v2.02,
  under Perl v5.010001 at Sat Oct  2 13:58:09 2010 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<a name='___top' class='dummyTopAnchor' ></a>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#What'>What</a>
  <li class='indexItem indexItem1'><a href='#Why'>Why</a>
  <li class='indexItem indexItem1'><a href='#But_why_not_just_use_the_clearly_superior_txn_do_transaction_control%3F'>But why not just use the clearly superior txn_do transaction control?</a>
  <li class='indexItem indexItem1'><a href='#But_this_never_worked_reliably!'>But this never worked reliably!</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="What"
>What</a></h1>

<p>Back in 2008 <a href="http://search.cpan.org/perldoc?DBIx%3A%3AClass" class="podlinkpod"
>DBIx::Class</a> introduced an object-guard based RDBMS transaction control in addition to the more widely known <code>-&#62;txn_do( sub { ...
} )</code>.
With <a href="http://perl5.git.perl.org/perl.git/commitdiff/96d9b9cd40f1d98fda790eb12b5cdbeef8b48a81" class="podlinkurl"
>this change to perl5</a> the object-guard becomes a rather dangerous source of silent bugs.
A <a href="http://rt.perl.org/rt3/Public/Bug/Display.html?id=76426" class="podlinkurl"
>bug was filed</a> against perl5 some months ago,
but was rejected (hopefully due to insufficient understanding of the problem).
Read on for details.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="Why"
>Why</a></h1>

<p>Often a programmer needs to make sure a set of RDBMS operations are atomic (the set of operations either completes entirely or not at all).
<a href="http://search.cpan.org/perldoc?DBI" class="podlinkpod"
>DBI</a> only provides a manual control of this process via <a href="http://search.cpan.org/perldoc?DBI#begin_work" class="podlinkpod"
>begin_work</a> to issue a <code>SQL &#39;BEGIN&#39;</code> transaction start,
and <a href="http://search.cpan.org/perldoc?DBI#commit" class="podlinkpod"
>commit</a> / <a href="http://search.cpan.org/perldoc?DBI#rollback" class="podlinkpod"
>rollback</a> issuing a <code>SQL &#39;COMMIT&#39;</code> or <code>SQL &#39;ROLLBACK&#39;</code> which finish the transaction with the corresponding outcome.</p>

<p><a href="http://search.cpan.org/perldoc?DBIx%3A%3AClass" class="podlinkpod"
>DBIx::Class</a> provides two ways to automate the handling of these calls.</p>

<p>With <a href="http://search.cpan.org/perldoc?DBIx%3A%3AClass%3A%3ASchema#txn_do" class="podlinkpod"
>txn_do</a> a <code>SQL &#39;BEGIN&#39;</code> is issued before execution of the supplied coderef begins.
The only two possible outcomes after this are:</p>

<ol>
<li>The coderef throws an exception,
in which case the exception is caught,
a <code>SQL &#39;ROLLBACK&#39;</code> is issued,
and the exception is re-thrown.</li>

<li>The coderef execution completes succesfully,
in which case a <code>SQL &#39;COMMIT&#39;</code> is issued and execution continues.</li>
</ol>

<p>With the <a href="http://search.cpan.org/perldoc?DBIx%3A%3AClass%3A%3AStorage%3A%3ATxnScopeGuard" class="podlinkpod"
>object guard</a> almost the entire transaction is under user control.
The <code>BEGIN</code> is issued at the point of the guard object instantiation.
From this point on there are three possible outcomes:</p>

<ol>
<li>The user explicitly commits the transaction by <code>$guard-&#62;commit</code>,
which issues a <code>SQL &#39;COMMIT&#39;</code> and sets a flag on the guard instance,
which turns the <a href="http://search.cpan.org/perldoc?DBIx%3A%3AClass%3A%3AStorage%3A%3ATxnScopeGuard#DESTROY" class="podlinkpod"
>&#34;DESTROY&#34; in DBIx::Class::Storage::TxnScopeGuard</a> into a noop.</li>

<li>The code after the guard instantiation runs normally,
and eventually perl leaves the scope instantiating the guard,
triggering garbage collection.
The <a href="http://search.cpan.org/perldoc?DBIx%3A%3AClass%3A%3AStorage%3A%3ATxnScopeGuard#DESTROY" class="podlinkpod"
>&#34;DESTROY&#34; in DBIx::Class::Storage::TxnScopeGuard</a> issues a <code>SQL &#39;ROLLBACK&#39;</code> while <b>also</b> issuing a warning about an uncommitted guard leaving scope,
alerting the user to a potential unintended <code>ROLLBACK</code> scenario in his code (e.g.
a rogue <code>return</code> in a block)</li>

<li>The code following the guard throws an exception,
triggering destruction of the guard <b>before</b> it had a chance to be <code>-&#62;commit</code>ed and before it reached the end of the scope which keept the object alive.
In this situation the <code>ROLLBACK</code> is expected and the warning normally emitted by <a href="http://search.cpan.org/perldoc?DBIx%3A%3AClass%3A%3AStorage%3A%3ATxnScopeGuard#DESTROY" class="podlinkpod"
>&#34;DESTROY&#34; in DBIx::Class::Storage::TxnScopeGuard</a> is suppressed by the presence of <code>$@</code></li>
</ol>

<p>After <a href="http://perl5.git.perl.org/perl.git/commitdiff/96d9b9cd40f1d98fda790eb12b5cdbeef8b48a81" class="podlinkurl"
>96d9b9c</a> it is no longer possible to tell apart <code>case 2</code> from <code>case 3</code> above,
since $@ is not visible in <code>DESTROY</code>.
With the current state of affairs <a href="http://search.cpan.org/perldoc?DBIx%3A%3AClass%3A%3AStorage%3A%3ATxnScopeGuard" class="podlinkpod"
>DBIx::Class::Storage::TxnScopeGuard</a> will have no choice but to be adjusted to not warn on <code>case 3</code>,
which makes it as unwieldy as manual <code>-&#62;txn_begin</code> / <code>-&#62;txn_commit</code> calls,
except much more dangerous: debugging &#34;why is my data gone&#34; due to <b>silent</b> rollbacks will be harder than just writing extra boilerplate any time you need finer transaction control.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="But_why_not_just_use_the_clearly_superior_txn_do_transaction_control?"
>But why not just use the clearly superior txn_do transaction control?</a></h1>

<p>Because it is much more flexible to be variable-bound than scope-bound.
For example one can easily pass a reference to the guard to an <b>unrelated scope</b>.
This in turn allows for much clearer code.
Compare the following:</p>

<pre>  sub with_deferred_constraints {
    my ($schema, $code, @args) = @_;

    $schema-&#62;txn_do ( sub {

      # needs to run in the txn
      # also the un-set needs to run before a commit
      $schema-&#62;_do_query(&#39;alter session set constraints = deferred&#39;);

      my $want = wantarray();
      my @res;

      try {
        if ($want) {
          @res = $code-&#62;(@args);
        }
        elsif (defined $want) {
          $res[0] = $code-&#62;(@args);
        }
        else {
          $code-&#62;(@args);
        }
      } finally {
        # unset in either rollback/commit case
        $self-&#62;_do_query(&#39;alter session set constraints = immediate&#39;);
      };

      return $want ? @res : $res[0];
    });
  }</pre>

<p>With its sibling:</p>

<pre>  sub with_deferred_constraints {
    my ($schema, $code, @args) = @_;

    my $txn_guard = $schema-&#62;txn_scope_guard (
      after_begin =&#62; sub {
        $schema-&#62;_do_query(&#39;alter session set constraints = deferred&#39;);
      },
      before_commit_or_destroy =&#62; sub {
        $schema-&#62;_do_query(&#39;alter session set constraints = immediate&#39;);
      },
    );

    return Context::Preserve::preserve_context (
      sub { $code-&#62;(@args) },
      after =&#62; sub { $txn_guard-&#62;commit }
    );
  }</pre>

<p>Also remember that databases are hateful. In some RDBMS a transaction comes with multiple strings attached (like e.g. refusing to start when multiple resultset handles are active). Thus code striving to be cross-platform must do everything it can to avoid starting a transaction unless absolutely necessary. With a transaction scope guard insertion of &#34;this parts needs to be atomic&#34; markers becomes much more natural, without weird inversion of control flow. Compare:</p>

<pre>  sub insert {
    my ($self, $obj) = @_;

    if (my @rels = $obj-&#62;parent_objects) {
      $self-&#62;txn_do ( sub {
        $_-&#62;insert for @rels;
        $obj-&#62;insert
      });
    }
    else {
      $obj-&#62;insert;
    }
  }</pre>

<p>To code without any duplication:</p>

<pre>  sub insert {
    my ($self, $obj) = @_;

    my $guard;

    for ($obj-&#62;parent_objects) {
      $guard ||= $self-&#62;txn_scope_guard;
      $_-&#62;insert;
    }

    $obj-&#62;insert;

    $guard-&#62;commit if $guard;
  }</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="But_this_never_worked_reliably!"
>But this never worked reliably!</a></h1>

<p>It is true that the following case would silently rollback <b>without</b> any indication (warning or otherwise) as to why is the data not in the db:</p>

<pre>  sub foo {
    my $guard = $schema-&#62;txn_scope_guard;

    eval {
      ...
      die &#34;Hard: With a Vengeance&#34;;
    };
  }</pre>

<p>The user did two stupid things here - he did not handle the exception (effectively hiding it), and forgot to handle the instantiated guard. Incidentally this sole corner case was used as justification to reject <a href="http://rt.perl.org/rt3/Public/Bug/Display.html?id=76426" class="podlinkurl"
>RT#76426</a>.</p>

<p>It is our hope that a different strategy will be adopted that will allow introspection of the <code>in exception</code> state, be it via <code>$@</code> or some new method (e.g. an argument to <code>DESTROY</code>)</p>

<!-- end doc -->

</body></html>
